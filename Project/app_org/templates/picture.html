{% extends 'base.html' %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/picture.css') }}">
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.querySelector('.submit-form');
        const fileInput = document.querySelector('input[type="file"]');
        const preview = document.getElementById('image-preview');
        const submitBtn = document.querySelector('.submit-btn');
        const description = document.querySelector('textarea[name="description"]');
        const counter = document.getElementById('char-counter');

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file && file.type.match('image/png')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                preview.style.display = 'none';
                alert('Please upload a valid PNG image.');
            }
        });

        description.addEventListener('input', () => {
            const remaining = 500 - description.value.length;
            counter.textContent = `${remaining} characters remaining`;
            if (remaining < 0) {
                counter.style.color = '#dc3545';
            } else {
                counter.style.color = '#ddd';
            }
        });

        form.addEventListener('submit', (e) => {
            if (!form.checkValidity()) {
                e.preventDefault();
                alert('Please fill all fields correctly.');
                return;
            }
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
            setTimeout(() => {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Design';
            }, 2000);
        });
    });
</script>
{% endblock %}

{% block content %}
{% include 'navbar.html' %}
<div class="contests-container">
    <header>
        <h1>Submit a Design for {{ contest.name }}</h1>
    </header>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="flash {{ category }}" role="alert">
        {{ message }}
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    {% if not contest.is_active %}
    <p class="no-contests" role="alert">This contest is not active. Please contact an admin.</p>
    {% else %}
    <form action="/submit_design" method="POST" enctype="multipart/form-data" class="submit-form" novalidate>
        <input type="hidden" name="contest_id" value="{{ contest.id }}">
        <div class="form-grid">
            <div class="form-group">
                <label for="name">Designer Name:</label>
                <input type="text" name="name" id="name" required aria-required="true" maxlength="100">
            </div>
            <div class="form-group">
                <label for="image">Upload Image (PNG only):</label>
                <input type="file" name="image" id="image" accept=".png" required aria-required="true">
                <figure id="image-preview" class="image-preview" style="display: none;">
                    <img src="" alt="Design Preview">
                    <figcaption>Preview of your uploaded design</figcaption>
                </figure>
            </div>
        </div>
        <button type="submit" class="submit-btn">Submit Design</button>
    </form>
    {% endif %}

    <div class="action-buttons">
        <a href="{{ url_for('main.contest_designs', contest_id=contest.id) }}">
            <button class="back-btn">Back</button>
        </a>
    </div>
</div>
{% endblock %}