{% extends 'base.html' %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/contests.css') }}">
<style>
  .contest-status {
    font-size: 0.95rem;
    font-weight: 500;
    margin-top: 8px;
  }
  .contest-status.active {
    color: #28a745;
  }
  .contest-status.ended {
    color: #dc3545;
  }
</style>
{% endblock %}

{% block content %}
{% include 'navbarAdmin.html' %}

<div class="contests-container">
    <header>
        <h1>Create New Contest</h1>
    </header>
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    {% set message_parts = message.split('||') %}
    {% set message_text = message_parts[0] %}
    {% set message_contest_id = message_parts[1] if message_parts|length > 1 else None %}
    {% if not message_contest_id %}
    <div class="flash {{ category }}">{{ message_text }}</div>
    {% endif %}
    {% endfor %}
    {% endif %}
    {% endwith %}
    <form action="/create_contest" method="POST" class="create-contest-form">
        <input type="text" name="contest_name" placeholder="Contest Name" required>
        <textarea name="rules" rows="10" placeholder="Enter contest rules (one per line)"></textarea>
        <label for="end_date">Data de fim</label>
        <input type="date" name="end_date" id="end_date" required>
        <button type="submit" class="submit-btn">Create Contest</button>
    </form> 
</div>

{% for contest in contests %}
<div class="contests-container" data-contest-id="{{ contest.id }}">
    <div class="contests-container" data-contest-id="{{ contest.id }}">
    <header>
        <h1>{{ contest.name }}</h1>
        {% if contest.end_date %}
          <p class="contest-status {{ 'active' if contest.is_active else 'ended' }}">
            {% if contest.is_active %}
              A decorrer até {{ contest.end_date.strftime('%d/%m/%Y') }}
            {% else %}
              Concurso terminou a {{ contest.end_date.strftime('%d/%m/%Y') }}
            {% endif %}
          </p>
        {% endif %}
    </header>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    {% set message_parts = message.split('||') %}
    {% set message_text = message_parts[0] %}
    {% set message_contest_id = message_parts[1] if message_parts|length > 1 else None %}
    {% if message_contest_id and message_contest_id | int == contest.id %}
    <div class="flash {{ category }}">{{ message_text }}</div>
    {% endif %}
    {% endfor %}
    {% endif %}
    {% endwith %}

    <div class="rules-section">
        <button class="rules-toggle-btn" onclick="toggleRules(this)">Contest Rules <span class="toggle-icon">▼</span></button>
        <div class="rules-content">
            <h3>Official Contest Rules</h3>
            {% if contest.rules %}
            <ul>
                {% for rule in contest.rules.split('\n') %}
                {% if rule.strip() %}
                <li>{{ rule.strip() }}</li>
                {% endif %}
                {% endfor %}
            </ul>
            {% else %}
            <p>No rules defined for this contest.</p>
            {% endif %}
        </div>
    </div>

    <div class="submissions-grid" id="submissions-grid-{{ contest.id }}">
        {% set approved_submissions = contest.submissions | selectattr('approved', 'equalto', True) | list %}
        {% for submission in approved_submissions[:3] %}
        <div class="submission {% if not contest.is_active and loop.index0 == 0 %}first{% elif not contest.is_active and loop.index0 == 1 %}second{% elif not contest.is_active and loop.index0 == 2 %}third{% endif %}" data-votes="{{ submission.votes if not contest.is_active else 0 }}">
            {% if not contest.is_active %}
            <div class="position-label">{{ loop.index0 + 1 }}{% if loop.index0 == 0 %}st{% elif loop.index0 == 1 %}nd{% elif loop.index0 == 2 %}rd{% else %}th{% endif %} Place</div>
            {% endif %}
            <img src="{{ url_for('static', filename='assets/' + submission.image) }}" alt="Submission T-shirt">
            <h2 class="submission-title">{{ submission.name | default('T-shirt Submission') }}</h2>
            <div class="submission-actions">
                {% if contest.is_active %}
                    <button class="vote-btn" disabled>Votes {{ submission.votes }}</button>
                {% else %}
                    <button class="vote-btn" disabled>Votes: {{ submission.votes }}</button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
        {% if not approved_submissions %}
            <p>No approved submissions for this contest.</p>
        {% endif %}
    </div>

    <div class="action-buttons">
        {% if approved_submissions | length > 3 %}
        <a href="{{ url_for('main.contest_designs', contest_id=contest.id) }}">
            <button class="back-btn">View More</button>
        </a>
        {% endif %}
        <a href="{{ url_for('main.edit_contest_rules', contest_id=contest.id) }}">
            <button class="submit-btn">Edit Contest</button>
        </a>
        <form action="/submit" method="GET" class="submit-form-right">
            <input type="hidden" name="contest_id" value="{{ contest.id }}">
            <button class="submit-btn">Submissions</button>
        </form>
        <form action="/end_contest/{{ contest.id }}" method="POST" class="submit-form-right">
            <button class="submit-btn end-contest-btn">End Contest</button>
        </form>
    </div>
</div>
{% endfor %}

<div class="global-actions">
    <form action="/ended_contests_admin" method="GET">
        <button class="submit-btn">View Ended Contests</button>
    </form>
</div>

<script>
function toggleRules(button) {
    const content = button.nextElementSibling;
    const icon = button.querySelector('.toggle-icon');
    if (content.style.display === 'block') {
        content.style.display = 'none';
        icon.textContent = '▼';
    } else {
        content.style.display = 'block';
        icon.textContent = '▲';
    }
}
</script>

{% endblock %}