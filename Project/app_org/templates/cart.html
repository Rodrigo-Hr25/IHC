{% extends 'base.html' %}

{% block styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/cart.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
{% endblock %}

{% block content %}
    {% include 'navbar.html' %}

    {% for message in get_flashed_messages() %}
        <div class="alert alert-success" role="alert">
            {{ message }}
        </div>
    {% endfor %}

    <main class="cart-container">
        <h1 class="page-title">Seu Carrinho</h1>
        <div class="content">
            <section class="cart-table">
                <table>
                    <thead>
                        <tr>
                            <th>Produto</th>
                            <th>Preço</th>
                            <th>Quantidade</th>
                            <th>Total</th>
                            <th>-</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product, quantity, cart_item in CartItem %}

                            <tr>
                                <td>
                                    <div class="product">
                                        {% if 'sweat' in product.name.lower() %}
                                        <img width="150" height="150" src="{{ url_for('static', filename='assets/sweat3.png') }}" alt="{{ product.name }}">
                                        {% else %}
                                        <img width="150" height="150" src="{{ url_for('static', filename='assets/' + product.image) }}" alt="{{ product.name }}">
                                        {% endif %}

                                        <div class="info">
                                            <div class="name">{{ product.name }}</div>
                                            <div class="category">{{ product.category.name }}</div>
                                            <div class="details">
                                                {% if cart_item.size %}
                                                    <span><strong>Tamanho:</strong> {{ cart_item.size }}</span><br>
                                                {% endif %}
                                                {% if cart_item.color %}
                                                    <span><strong>Cor:</strong> {{ cart_item.color }}</span><br>
                                                {% endif %}
                                                {% if cart_item.custom_text %}
                                                    <span><strong>Costumize</strong> {{ cart_item.custom_text }}</span><br>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td>{{ product.price }}€</td>
                                <td>
                                    <form action="/cart/update/{{ product.id }}" method="POST">
                                        <div class="qty" data-product-id="{{ product.id }}">
                                            <button type="button" class="decrease">-</button>
                                            <input type="number" class="quantity" value="{{ quantity }}" name="quantity" min="1">
                                            <button type="button" class="increase">+</button>
                                        </div>
                                    </form>
                                </td>
                                <td>{{ (product.price * quantity) | int }}€</td>
                                <td>
                                    <form action="/cart/remove/{{ product.id }}" method="POST">
                                        <button class="remove"><i class="bx bx-x"></i></button>
                                    </form>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </section>
            <aside class="cart-summary">
                <div class="box">
                    <header>Resumo da Compra</header>
                    <div class="info">
                        <div><span>Subtotal</span><span>{{ total }}€</span></div>
                        <div><span>Portes</span><span>0€</span></div>
                    </div>
                    <footer>
                        <span>Total</span>
                        <span>{{ total }}€</span>
                    </footer>
                </div>
                <form class="botao" action="/cart/checkout" method="POST">
                    <button type="submit">Finalizar Compra</button>
                </form>
            </aside>
        </div>
    </main>
{% endblock %}

{% block scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const qtyControls = document.querySelectorAll('.qty');

            qtyControls.forEach(control => {
                const decreaseBtn = control.querySelector('.decrease');
                const increaseBtn = control.querySelector('.increase');
                const quantityInput = control.querySelector('.quantity');
                const productId = control.dataset.productId;

                const updateQuantity = (newValue) => {
                    if (newValue < 1) newValue = 1;
                    quantityInput.value = newValue;

                    fetch(`/cart/update/${productId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: `quantity=${newValue}`
                    }).then(response => {
                        if (response.redirected) {
                            window.location.href = response.url;
                        } else {
                            window.location.reload();
                        }
                    });
                };

                decreaseBtn.addEventListener('click', () => {
                    let value = parseInt(quantityInput.value);
                    updateQuantity(value - 1);
                });

                increaseBtn.addEventListener('click', () => {
                    let value = parseInt(quantityInput.value);
                    updateQuantity(value + 1);
                });

                quantityInput.addEventListener('change', () => {
                    let value = parseInt(quantityInput.value);
                    updateQuantity(value);
                });
            });
        });
    </script>
{% endblock %}
