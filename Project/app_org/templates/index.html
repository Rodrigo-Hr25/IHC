{% extends 'base.html' %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}" />
{% endblock %}

{% block content %}
  {% include 'navbar.html' %}

  {% for message in get_flashed_messages() %}
    <div class="alert alert-success" role="alert">{{ message }}</div>
  {% endfor %}

  <header>
    <h1>DETI MERCH</h1>
  </header>

  <div class="page-container" style="display: flex; justify-content: flex-start; margin-left: 0; padding: 0 20px; width: 100%;">
    <div class="filters-column" style="margin: 0; margin-right: 10px;">
      {% set filter_action='main.index' %}
      {% include '_filters.html' %}
    </div>  

    <div class="products-center" style="margin: 0 auto; max-width: 1200px;">
      <div class="row product-container">
        {% for product in products %}
          <div class="product col-md-12">
            <img
              class="card-img-top"
              src="{{ url_for('static', filename='assets/' + product.image) }}"
              alt="{{ product.name }}"
            />
            <h2 class="card-title">{{ product.name }}</h2>
            <p>{{ product.description }}</p>
            <p class="card-price">{{ product.price | int }}€</p>
            <p class="stock-status {% if product.quantity > 0 %}in-stock{% else %}out-of-stock{% endif %}">
              {% if product.quantity > 0 %}In Stock{% else %}Out of Stock{% endif %}
            </p>
            <form action="/product/{{ product.id }}" method="GET">
              <button class="view-product"><i class="bx bx-show"></i> View Product</button>
            </form>
            <form action="/cart/add/{{ product.id }}" method="POST">
              <button class="add-to-cart">
                <i class="bx bx-cart-add"></i>Add to Cart
              </button>
            </form>
            <form class="favorite-form" data-product-id="{{ product.id }}">
              <button type="button" class="add-to-favorites {% if product in user.wishlist_products %}favorited{% endif %}">♥</button>
            </form>
          </div>
          {% if loop.index % 3 == 0 and not loop.last %}
            </div>
            <div class="row product-container">
          {% endif %}
        {% endfor %}
      </div>
    </div>
    
  </div>
{% endblock %}

{% block scripts %}
<script>
document.querySelectorAll('.favorite-form').forEach(form => {
  const button = form.querySelector('.add-to-favorites');
  const productId = form.dataset.productId;

  button.addEventListener('click', () => {
    fetch(`/favorites/toggle/${productId}`, {
      method: 'POST'
    }).then(res => {
      if (res.ok) {
        button.classList.toggle('favorited');
      }
    });
  });
});
</script>
{% endblock %}


