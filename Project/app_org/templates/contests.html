{% extends 'base.html' %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/contests.css') }}">
{% endblock %}

{% block content %}
{% include 'navbar.html' %}
{% for contest in contests %}
<div class="contests-container" data-contest-id="{{ contest.id }}">
    <header>
        <h1>{{ contest.name }}</h1>
    </header>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    {% set message_parts = message.split('||') %}
    {% set message_text = message_parts[0] %}
    {% set message_contest_id = message_parts[1] if message_parts|length > 1 else None %}
    {% if message_contest_id and message_contest_id | int == contest.id %}
    <div class="flash {{ category }}">{{ message_text }}</div>
    {% endif %}
    {% endfor %}
    {% endif %}
    {% endwith %}

    <!-- Contest Rules Section -->
    <div class="rules-section">
        <button class="rules-toggle-btn" onclick="toggleRules(this)">Contest Rules <span class="toggle-icon">â–¼</span></button>
        <div class="rules-content">
            <h3>Official Contest Rules</h3>
            <ul>
                <li><strong>Eligibility:</strong> Participants must be registered users of the platform.</li>
                <li><strong>Submission Limit:</strong> Only one submission per user per contest is allowed.</li>
                <li><strong>Originality:</strong> Designs must be original and not infringe on any copyrights or trademarks.</li>
                <li><strong>Content Guidelines:</strong> Submissions must be appropriate and not contain offensive content.</li>
                <li><strong>Voting:</strong> Each user can vote for only one submission per contest. You can change your vote by unvoting and voting for another submission.</li>
                <li><strong>Contest Duration:</strong> The contest ends when the admin closes it. Winners are determined by the highest number of votes.</li>
                <li><strong>Prizes:</strong> The top 3 winners may have their designs printed and receive store credit (prizes subject to admin discretion).</li>
                <li><strong>Disqualification:</strong> The admin reserves the right to disqualify submissions that violate these rules.</li>
            </ul>
        </div>
    </div>

    <div class="submissions-grid" id="submissions-grid-{{ contest.id }}">
        {% set approved_submissions = contest.submissions.filter_by(approved=True).all() | list %}
        {% for submission in approved_submissions[:3] %}
        <div class="submission {% if not contest.is_active and loop.index0 == 0 %}first{% elif not contest.is_active and loop.index0 == 1 %}second{% elif not contest.is_active and loop.index0 == 2 %}third{% endif %}" data-votes="{{ submission.votes if not contest.is_active else 0 }}" style="animation-delay: {{ loop.index0 * 0.1 }}s">
            {% if not contest.is_active %}
            {% set position_map = ['1st Place', '2nd Place', '3rd Place'] %}
            <div class="position-label">
                {{ position_map[loop.index0] if loop.index0 < 3 else (loop.index0 + 1) ~ 'th Place' }}
            </div>
            {% endif %}

            <img src="{{ url_for('static', filename='assets/' + submission.image) }}" alt="Submission T-shirt">
            <h2 class="submission-title">{{ submission.name | default('T-shirt Submission') }}</h2>
            <div class="submission-actions">
                {% if contest.is_active %}
                    {% if submission.id in voted_submission_ids %}
                        <form action="/unvote/{{ submission.id }}" method="POST">
                            <button class="vote-btn voted">Voted âœ“</button>
                        </form>
                    {% else %}
                        <form action="/vote/{{ submission.id }}" method="POST" onsubmit="setTimeout(reorderSubmissionsWithAnimation, 100);">
                            <button class="vote-btn">Vote</button>
                        </form>
                    {% endif %}
                {% else %}
                    <button class="vote-btn" disabled>Contest Ended</button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
        {% if not approved_submissions %}
            <p>No approved submissions for this contest.</p>
        {% endif %}
    </div>

    <div class="action-buttons">
        {% if approved_submissions | length > 3 %}
        <a href="{{ url_for('main.contest_designs', contest_id=contest.id) }}">
            <button class="back-btn">View More</button>
        </a>
        {% endif %}
    </div>
</div>
{% endfor %}

<div class="global-actions">
    <form action="/picture" method="GET">
        <button class="submit-btn">Submit New Design</button>
    </form>
    <form action="{{ url_for('main.ended_contests') }}" method="GET">
        <button class="submit-btn">View Ended Contests</button>
    </form>
</div>

<script>
window.addEventListener('DOMContentLoaded', () => {
    const lightbox = document.createElement('div');
    lightbox.id = 'lightbox';
    document.body.appendChild(lightbox);

    const images = document.querySelectorAll('.submission img');
    images.forEach(img => {
        img.addEventListener('click', () => {
            lightbox.innerHTML = '';
            const clone = img.cloneNode();
            lightbox.appendChild(clone);
            lightbox.style.display = 'flex';
        });
    });

    lightbox.addEventListener('click', () => {
        lightbox.style.display = 'none';
    });
});
</script>

<script>
window.addEventListener('DOMContentLoaded', () => {
    contests.forEach(contest => {
        const submissions = Array.from(document.querySelectorAll(`#submissions-grid-${contest.id} .submission`));
        const lastPositions = JSON.parse(localStorage.getItem(`submissionPositions-${contest.id}`)) || {};

        submissions.forEach((sub, index) => {
            const id = sub.querySelector('form')?.action.split('/vote/')[1];
            const currentPos = index + 1;
            const lastPos = lastPositions[id];

            const label = sub.querySelector('.position-label');
            const arrow = document.createElement('span');
            arrow.style.marginLeft = '8px';

            if (lastPos && !contest.is_active) {
                if (currentPos < lastPos) {
                    arrow.textContent = 'ðŸ”¼';
                    arrow.title = `Subiu de ${lastPos} para ${currentPos}`;
                } else if (currentPos > lastPos) {
                    arrow.textContent = 'ðŸ”½';
                    arrow.title = `Desceu de ${lastPos} para ${currentPos}`;
                } else {
                    arrow.textContent = 'âž–';
                    arrow.title = 'Manteve posiÃ§Ã£o';
                }
                label.appendChild(arrow);
            }

            if (!contest.is_active) {
                lastPositions[id] = currentPos;
            }
        });

        localStorage.setItem(`submissionPositions-${contest.id}`, JSON.stringify(lastPositions));
    });
});
</script>

<script>
function toggleRules(button) {
    const content = button.nextElementSibling;
    const icon = button.querySelector('.toggle-icon');
    if (content.style.display === 'block') {
        content.style.display = 'none';
        icon.textContent = 'â–¼';
    } else {
        content.style.display = 'block';
        icon.textContent = 'â–²';
    }
}
</script>

{% endblock %}